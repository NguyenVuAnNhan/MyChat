<!DOCTYPE html>
<html>
    <head>
      <link rel="icon" type="image/png" href="/static/image/favicon.ico">
        <title>FastAPI Chat</title>
        <style>
            body {font-family: sans-serif;}
            #chat { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 1em; }
        </style>
    </head>
    <body>
      <div id="header"></div>
      <script>
      (async () => {
        const html = await (await fetch("/static/header.html")).text();
        document.getElementById("header").innerHTML = html;
      
        const s = document.createElement("script");
        s.src = "/static/js/header.js";
        s.onload = () => window.renderHeader && window.renderHeader(); // call explicitly
        document.body.appendChild(s);
      })();
      </script>
      
      
        <h1>FastAPI Web Chat</h1>
        <div id="chat"></div>
        <input type="text" id="messageInput" placeholder="Say something..." />
        <button onclick="sendMessage()">Send</button>

        <script>
            const chat = document.getElementById("chat");
            const input = document.getElementById("messageInput");

            const pathParts = window.location.pathname.split("/t/");
            const room = pathParts[pathParts.length - 1] || "lobby";

            async function loadHistory(room) {
                const res = await fetch(`/api/${room}/history`);
                const history = await res.json();
                history.forEach(msg => {
                    const el = document.createElement("div");
                    el.textContent = `${msg.message}`;
                    chat.appendChild(el);
                });
            }

            loadHistory(room);

            const ws = new WebSocket(`ws://${location.host}/ws/${room}`);

            ws.onopen = () => {
                ws.send(JSON.stringify({ type: "join" }));
            };

        
            ws.onmessage = (event) => {
              const msg = document.createElement("div");
              msg.textContent = event.data;
              chat.appendChild(msg);
              chat.scrollTop = chat.scrollHeight;
            };
        
            function sendMessage() {
              const message = input.value.trim();
              if (message) {
                ws.send(JSON.stringify({type: "chat", message}));
                input.value = "";
              }
            }
        
            input.addEventListener("keydown", (e) => {
              if (e.key === "Enter") sendMessage();
            });
          </script>
    </body>
</html>